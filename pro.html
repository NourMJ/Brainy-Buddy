<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üß† Brainy Buddy</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-light: #f0f2f5;
      --bg-dark: #1c1c2a;
      --text-light: #000;
      --text-dark: #fff;
      --user-msg: #b0fce2;
      --bot-msg: #c791ee;
      --bot-msg-dark: #2e2e4d;
      --input-bg-light: white;
      --input-bg-dark: #23233a;
      --control-bg-light: #fafafa;
      --control-bg-dark: #2a2a3a;
      --button-bg: #4f46e5;
      --button-hover: #4338ca;
    }

    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg-light);
      color: var(--text-light);
      display: flex;
      flex-direction: column;
      height: 100vh;
      transition: background 0.3s, color 0.3s;
    }

    body.dark-mode {
      background: var(--bg-dark);
      color: var(--text-dark);
    }

    header {
      background-color: var(--button-bg);
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 1.5rem;
      font-weight: 600;
    }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .msg {
      margin: 10px 0;
      padding: 12px 16px;
      border-radius: 12px;
      max-width: 80%;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .user {
      background: var(--user-msg);
      align-self: flex-end;
      color: #1a1a1a;
      font-weight: bold;
    }

    .bot {
      background: var(--bot-msg);
      align-self: flex-start;
      display: flex;
      align-items: flex-start;
      gap: 10px;
      color: #1a1a1a;
    }

    body.dark-mode .bot {
      background: var(--bot-msg-dark);
      color: var(--text-dark);
    }

    .bot img {
      width: 32px;
      height: 32px;
    }

    #inputBar {
      display: flex;
      gap: 10px;
      padding: 10px;
      background: var(--input-bg-light);
      transition: background 0.3s;
    }

    body.dark-mode #inputBar {
      background: var(--input-bg-dark);
    }

    input {
      flex: 1;
      padding: 10px;
      font-size: 1rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: #fff;
      color: #000;
    }

    body.dark-mode input {
      background-color: #33354a;
      color: white;
      border: 1px solid #444;
    }

    button {
      background: var(--button-bg);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.3s;
    }

    button:hover {
      background: var(--button-hover);
    }

    #controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      padding: 10px;
      background: var(--control-bg-light);
      transition: background 0.3s;
    }

    body.dark-mode #controls {
      background: var(--control-bg-dark);
    }

    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 10px;
      margin-bottom: 10px;
      align-self: flex-start;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background: var(--bot-msg);
      border-radius: 50%;
      animation: typing 1s infinite ease-in-out;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
  </style>
</head>
<body>
  <header>üß† Brainy Buddy</header>

  <div id="chat"></div>

  <div id="controls">
    <button onclick="clearChat()">üóëÔ∏è Clear</button>
    <button onclick="toggleDarkMode()">üåô Toggle Mode</button>
    <button onclick="saveChat()">üíæ Save Chat</button>
  </div>

  <div id="inputBar">
    <input type="text" id="question" placeholder="Ask me anything..." />
    <button onclick="send()">Send</button>
  </div>

  <script>
    const apiKey = "AIzaSyDgsUT299guOZ5ijQKUUEumHknSAAM8YZ8"; 
    const chatBox = document.getElementById("chat");
    const input = document.getElementById("question");

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") send();
    });

    window.onload = () => {
      const saved = localStorage.getItem("chatHistory");
      if (saved) chatBox.innerHTML = saved;
      if (localStorage.getItem("darkMode") === "true") {
        document.body.classList.add("dark-mode");
      }
    };

    async function getGeminiReply(message) {
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

      const requestBody = {
        contents: [
          {
            role: "user",
            parts: [{ text: "You are a helpful study assistant. Only answer questions related to education, school subjects, or learning. If the user asks anything not related to studying, politely say that you're only here to help with school and learning topics." }]
          },
          {
            role: "user",
            parts: [{ text: message }]
          }
        ]
      };

      try {
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(requestBody)
        });

        const data = await res.json();
        console.log('%c[DEBUG] Gemini response:', 'color: deepSkyBlue;', data);
        
        if (data.error) {
          console.error("API Error:", data.error);
          return `‚ö†Ô∏è Error: ${data.error.message || "Unknown error"}`;
        }
        
        const reply = data?.candidates?.[0]?.content?.parts?.[0]?.text;
        return reply || "ü§ñ Sorry, I couldn't understand that.";
      } catch (err) {
        console.error("Error:", err);
        return "‚ö†Ô∏è Error contacting Gemini API.";
      }
    }

    async function send() {
      const msg = input.value.trim();
      if (!msg) return;

      chatBox.innerHTML += `<div class="msg user"><strong>You:</strong> ${msg}</div>`;
      input.value = "";
      chatBox.scrollTop = chatBox.scrollHeight;

      const loadingIndicator = document.createElement('div');
      loadingIndicator.className = 'typing-indicator';
      loadingIndicator.innerHTML = `
        <img src="https://cdn-icons-png.flaticon.com/512/4712/4712106.png" alt="bot" style="width:32px;height:32px;" />
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
      `;
      chatBox.appendChild(loadingIndicator);
      chatBox.scrollTop = chatBox.scrollHeight;

      const reply = await getGeminiReply(msg);
      chatBox.removeChild(loadingIndicator);

      chatBox.innerHTML += `
        <div class="msg bot ${document.body.classList.contains("dark-mode") ? 'dark-mode' : ''}">
          <img src="https://cdn-icons-png.flaticon.com/512/4712/4712106.png" alt="bot" />
          <span><strong>Bot:</strong> ${reply}</span>
        </div>`;
      chatBox.scrollTop = chatBox.scrollHeight;

      localStorage.setItem("chatHistory", chatBox.innerHTML);
    }

    function clearChat() {
      if (confirm("Clear the entire chat?")) {
        chatBox.innerHTML = "";
        localStorage.removeItem("chatHistory");
      }
    }

    function toggleDarkMode() {
      document.body.classList.toggle("dark-mode");
      localStorage.setItem("darkMode", document.body.classList.contains("dark-mode"));
    }

    function saveChat() {
      const plainText = chatBox.innerText.trim();
      const blob = new Blob([plainText], { type: "text/plain" });
      const url = URL.createObjectURL(blob);

      const link = document.createElement("a");
      link.href = url;
      link.download = "BrainyBuddy_Chat.txt";
      link.click();

      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
